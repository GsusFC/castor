AI Brand Mode
Brand Context Global â€” VisiÃ³n y DiseÃ±o (v2)
Objetivo
Habilitar que todas las features de IA generativa de Castor produzcan outputs consistentes con la voz de marca de una cuenta (brand voice) y sus reglas, sin exponer prompts editables a usuarios finales.
Principios
	â€¢	El contexto de marca se gestiona a nivel de cuenta (account-level), orientado a equipos/marcas.
	â€¢	No se permite ediciÃ³n directa de prompts: el control se hace mediante datos estructurados.
	â€¢	El sistema debe ser consistente: cualquier surface de IA generativa debe operar con un accountId y su contexto.
	â€¢	SeparaciÃ³n clara entre traducciÃ³n literal (gratis, no IA) y traducciÃ³n con voz (IA generativa, brand-aware).
Definiciones
Brand Context (Knowledge Base): datos estructurados persistidos en account_knowledge_base.
BrandVoice: texto breve que describe cÃ³mo escribe la marca (tono, estilo, vocabulario, formato).
AI Brand Mode: estado ON/OFF que indica si se debe aplicar contexto de marca a la IA generativa.
IA generativa: modelos que producen texto nuevo (write, improve, reply, insights/chat, translate con voz).
Alcance
Incluye (IA generativa, brand-aware)
Asistente IA: write, improve, translate (con voz/localizaciÃ³n)
AI Replies: sugerencias de respuesta
Analytics: insights/chat y recomendaciones generadas
Excluye
Translate literal del cast: feature gratis que ya funciona. No aplica brand voice. Debe permanecer literal sin reescritura estilÃ­stica.
Fuente de verdad de contexto
Persistencia (DB)
account_knowledge_base: brandVoice, bio, expertise (array), alwaysDo (array), neverDo (array), hashtags (array), defaultTone, defaultLanguage, internalNotes, brand_voice_history (JSONB array)
account_documents: documentos adjuntos (brand guidelines, claims, FAQs, etc.)
UI
PÃ¡gina de ediciÃ³n: /accounts/[id]/context (ContextEditor)
ActivaciÃ³n de AI Brand Mode (gating)
Regla de activaciÃ³n (v1)
	â€¢	AI Brand Mode = ON si brandVoice existe y no estÃ¡ vacÃ­o.
	â€¢	AI Brand Mode = OFF en caso contrario.
neverDo NO es obligatorio para activar (se considera recomendado).
Manejo del caso "All accounts"
Regla
Cuando el usuario tiene seleccionada la vista "All accounts", las features de IA generativa quedan bloqueadas con un mensaje que solicita seleccionar una cuenta especÃ­fica.
JustificaciÃ³n
	â€¢	Evita confusiÃ³n sobre quÃ© contexto de marca se estÃ¡ aplicando.
	â€¢	Previene errores de publicaciÃ³n con voz incorrecta.
	â€¢	Simplifica la lÃ³gica de accountId (siempre requerido, nunca inferido).
UI propuesta
En cualquier surface de IA generativa (AITabs, AI Reply, Analytics), si no hay cuenta seleccionada:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â„¹ï¸  Selecciona una cuenta                   â”‚
â”‚                                             â”‚
â”‚  Para usar el asistente de IA necesitas    â”‚
â”‚  elegir una cuenta especÃ­fica.             â”‚
â”‚                                             â”‚
â”‚  [Selector de cuenta inline]               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ImplementaciÃ³n
	â€¢	Verificar selectedAccountId antes de renderizar controles de IA.
	â€¢	Si es null o "all", mostrar el bloqueo.
	â€¢	El selector inline permite cambiar sin salir del contexto actual.
Onboarding propuesto
Objetivo
Reducir fricciÃ³n: que el usuario pueda activar Brand Mode en minutos.
CTA
En cada surface de IA generativa (Studio/AITabs, AI Reply, Analytics), si Brand Mode estÃ¡ OFF:
	â€¢	Mostrar banner/notice: "Activa AI Brand Mode completando tu Brand Voice."
	â€¢	CTA: "Completar contexto" â†’ /accounts/[id]/context (cuenta activa)
Estados UX
	â€¢	OFF: no hay brandVoice.
	â€¢	ON: brandVoice presente.
	â€¢	(Opcional) INCOMPLETE: KB existe pero brandVoice vacÃ­o; mismo CTA.
"Translate con voz" (AIAssistant translate)
IntenciÃ³n
No es traducciÃ³n literal; es localizaciÃ³n brand-aware:
	â€¢	Mantener significado.
	â€¢	Ajustar tono/registro a brandVoice.
	â€¢	Respetar reglas (alwaysDo/neverDo) si existen.
Reglas
	â€¢	Output: solo la versiÃ³n final (sin explicaciones).
	â€¢	No inventar facts.
	â€¢	Si el texto contiene claims sensibles: mantenerse conservador.
RegeneraciÃ³n y versionado de BrandVoice
Principio
El BrandVoice nunca se sobreescribe silenciosamente. Cualquier regeneraciÃ³n es una propuesta de actualizaciÃ³n que el usuario compara con la versiÃ³n actual y decide cÃ³mo resolver.
Triggers de regeneraciÃ³n
	â€¢	EvoluciÃ³n natural del estilo (paso del tiempo)
	â€¢	Rebrand consciente
	â€¢	BrandVoice inicial de baja calidad
	â€¢	MigraciÃ³n de cuenta con nuevo historial
Flujo de regeneraciÃ³n
	â€¢	Usuario solicita "Actualizar BrandVoice"
	â€¢	Selecciona ventana temporal (3 o 6 meses)
	â€¢	Sistema genera nueva propuesta
	â€¢	UI muestra comparaciÃ³n lado a lado (actual vs nuevo)
	â€¢	Usuario elige: Usar nuevo, Combinar ambos, o Conservar actual

UI de comparaciÃ³n
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“Š ComparaciÃ³n de BrandVoice                                   â”‚
â”‚                                                                 â”‚
â”‚  ACTUAL                          NUEVO (propuesto)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Tono directo y tÃ©cnico, â”‚     â”‚ Tono directo pero mÃ¡s   â”‚    â”‚
â”‚  â”‚ sin rodeos. Usa         â”‚     â”‚ conversacional. Usa     â”‚    â”‚
â”‚  â”‚ analogÃ­as de producto.  â”‚     â”‚ analogÃ­as de producto   â”‚    â”‚
â”‚  â”‚ Prefiere frases cortas. â”‚     â”‚ y referencias a la      â”‚    â”‚
â”‚  â”‚ Evita emojis salvo ğŸ”¥    â”‚     â”‚ comunidad. MÃ¡s emojis.  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                 â”‚
â”‚  Cambios detectados:                                            â”‚
â”‚  â€¢ + "mÃ¡s conversacional"                                       â”‚
â”‚  â€¢ + "referencias a la comunidad"                               â”‚
â”‚  â€¢ ~ emojis: de "ocasionalmente" a "mÃ¡s frecuente"              â”‚
â”‚                                                                 â”‚
â”‚  [Usar nuevo]  [Combinar ambos]  [Conservar actual]             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

GeneraciÃ³n de merge
Prompt interno para combinar versiones:
Combina estos dos BrandVoice en uno coherente.
Prioriza elementos especÃ­ficos sobre genÃ©ricos.
Conserva restricciones explÃ­citas ("nunca", "siempre", "evita").
MÃ¡ximo 200 palabras.

ACTUAL: {current_brand_voice}
NUEVO: {new_brand_voice}

HistÃ³rico de versiones
Modelo de datos
interface BrandVoiceHistoryEntry {
  id: string;
  content: string;
  createdAt: Date;
  source: 'manual' | 'generated' | 'merged';
  castsAnalyzed?: number;
  castsPeriod?: string;
  previousId?: string;
}

Almacenamiento: campo brand_voice_history (JSONB array) en account_knowledge_base.
Reglas
	â€¢	MÃ¡ximo 10 versiones conservadas.
	â€¢	Versiones mÃ¡s antiguas se eliminan (soft delete opcional para auditorÃ­a).
	â€¢	Cada guardado (nuevo, actualizaciÃ³n, restauraciÃ³n) crea una entrada.
UI de histÃ³rico
Accesible desde /accounts/[id]/context:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“œ Historial de BrandVoice                                     â”‚
â”‚                                                                 â”‚
â”‚  Actual (guardado hace 2 dÃ­as)                    [Activo]      â”‚
â”‚  â””â”€ Merged â€¢ 127 casts â€¢ Ene-Jun 2024                           â”‚
â”‚                                                                 â”‚
â”‚  VersiÃ³n anterior (hace 4 meses)                  [Restaurar]   â”‚
â”‚  â””â”€ Generated â€¢ 89 casts â€¢ Sep-Dic 2023                         â”‚
â”‚                                                                 â”‚
â”‚  Primera versiÃ³n (hace 8 meses)                   [Restaurar]   â”‚
â”‚  â””â”€ Manual                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

IntegraciÃ³n de account_documents en el system prompt
JerarquÃ­a de contexto
	â€¢	brandVoice â†’ cÃ³mo escribe la marca (tono, estilo)
	â€¢	alwaysDo/neverDo â†’ reglas operativas
	â€¢	documents_summary â†’ quÃ© puede decir (claims, facts, messaging)
LÃ³gica de integraciÃ³n
brandVoice y documents_summary operan en dimensiones distintas: brandVoice = el cÃ³mo, documents_summary = el quÃ©. No compiten; se concatenan con roles claros en el system prompt:
Tu voz de marca:
{brandVoice}

InformaciÃ³n oficial de la marca (no inventar fuera de esto):
{documents_summary}

Reglas:
- Siempre: {alwaysDo}
- Nunca: {neverDo}

LÃ­mites (sin RAG)
	â€¢	documents_summary limitado a ~500-800 tokens.
	â€¢	SelecciÃ³n manual de quÃ© documentos incluir en el resumen.
	â€¢	Cuando se requiera mayor fidelidad, implementar RAG (fuera de scope v1).
GeneraciÃ³n automÃ¡tica (asistida) del contexto
BrandVoice a partir de casts (Neynar + anÃ¡lisis IA)
BrandVoice puede generarse automÃ¡ticamente a partir del historial de la cuenta.
Â¿CuÃ¡ntos casts analizar?
RecomendaciÃ³n prÃ¡ctica:
	â€¢	80â€“150 casts: mejor balance calidad/coste (recomendado).
	â€¢	30â€“60 casts: onboarding rÃ¡pido (mÃ¡s sesgo).
	â€¢	200â€“400 casts: cuentas con mÃºltiples temÃ¡ticas o estilo editorial.
	â€¢	800â€“1000 casts: rendimientos decrecientes para BrandVoice puro.
Muestreo recomendado
	â€¢	Ventana temporal: 3â€“6 meses (marca actual).
	â€¢	Priorizar casts originales (texto propio).
	â€¢	Excluir posts vacÃ­os/solo links.
	â€¢	Dedupe de plantillas repetidas.
	â€¢	Incluir una fracciÃ³n de replies si quieres reflejar estilo conversacional.
neverDo auto-sugerido (confirmable)
neverDo puede sugerirse automÃ¡ticamente y requerir confirmaciÃ³n explÃ­cita del usuario.
UX sugerido en /accounts/[id]/context:
	â€¢	Bloque: "Sugerir reglas (never do) automÃ¡ticamente"
	â€¢	AcciÃ³n: "Generar sugerencias"
	â€¢	UI: checklist + "Aplicar seleccionadas"
Manejo de errores en generaciÃ³n de BrandVoice
Estados y umbrales
Estado
CondiciÃ³n
Comportamiento
insufficient_data
< 30 casts (filtrados)
Bloquear generaciÃ³n, ofrecer escritura manual
low_confidence
30-79 casts, o alta varianza
Warning visible, resultado editable
success
80+ casts, seÃ±al clara
Resultado editable, flujo normal
generation_failed
Error de API (Neynar o IA)
Retry automÃ¡tico (1x), fallback manual
too_generic
ValidaciÃ³n detecta frases vacÃ­as
Sugerir ediciÃ³n o regenerar

DetecciÃ³n de alta varianza
HeurÃ­sticas que disparan low_confidence:
	â€¢	> 50% de casts son solo links/media sin texto
	â€¢	Mezcla de 3+ idiomas sin patrÃ³n dominante
	â€¢	DesviaciÃ³n estÃ¡ndar de longitud de casts > 80% de la media
ValidaciÃ³n post-generaciÃ³n
Antes de mostrar el resultado:
	â€¢	Â¿Menos de 50 caracteres? â†’ Regenerar automÃ¡ticamente (1x)
	â€¢	Â¿Contiene frases genÃ©ricas? (lista negra: "profesional y cercano", "amigable pero formal") â†’ Marcar como too_generic
	â€¢	Â¿MÃ¡s de 1500 caracteres? â†’ Truncar con aviso
UI por estado
insufficient_data
âš ï¸ Necesitas mÃ¡s historial

Encontramos solo {n} casts en los Ãºltimos 6 meses.
Para generar un BrandVoice fiable necesitamos al menos 30.

[Escribir manualmente]  [Cancelar]

low_confidence
ğŸ¤” Resultado preliminar

Tu historial es muy variado, asÃ­ que este BrandVoice
es un punto de partida. Te recomendamos editarlo.

[Ver resultado y editar]

generation_failed
âŒ No pudimos generar tu BrandVoice

Hubo un problema al analizar tus casts.

[Reintentar]  [Escribir manualmente]

too_generic
ğŸ˜ El resultado es demasiado genÃ©rico

No encontramos suficiente seÃ±al distintiva en tus casts.
Te recomendamos escribirlo manualmente o editar esto como base.

[Editar resultado]  [Escribir desde cero]

Consistencia tÃ©cnica (diseÃ±o)
Regla de oro
Toda llamada de IA generativa debe ejecutarse con un accountId (cuenta activa) cargando AccountContext desde esa cuenta.
Consideraciones
	â€¢	Centralizar la construcciÃ³n de contexto (system context) en una funciÃ³n Ãºnica (p.ej. buildSystemContext(...)).
	â€¢	Reutilizar el mismo contrato de datos entre assistant/replies/analytics.
ImplementaciÃ³n (checklist)
Esta secciÃ³n describe quÃ© tocar en el cÃ³digo para llevar esta visiÃ³n a producciÃ³n. No es un refactor masivo: es un set de cambios pequeÃ±os pero consistentes.
Plan por PRs (ejecuciÃ³n recomendada)
PR1 â€” Brand Mode gating + CTA (solo UI)
Objetivo: que el usuario entienda y pueda activar Brand Mode.
Scope: Banner/notice cuando Brand Mode estÃ¡ OFF. CTA a /accounts/[id]/context con la cuenta activa.
Archivos: src/components/compose/AITabs.tsx, src/components/feed/AIReplyDialog.tsx
Criterio: Si brandVoice estÃ¡ vacÃ­o, se ve el CTA. Si brandVoice existe, el CTA no aparece.

PR1.1 â€” Bloqueo de IA en "All accounts"
Objetivo: impedir uso de IA generativa sin cuenta seleccionada.
Scope: Verificar selectedAccountId antes de renderizar IA generativa.
Archivos: src/components/compose/AITabs.tsx, src/components/feed/AIReplyDialog.tsx, src/context/SelectedAccountContext.tsx
Criterio: Si no hay cuenta seleccionada, mostrar bloqueo con selector inline.

PR2 â€” Propagar accountId a IA generativa (assistant + replies)
Objetivo: asegurar consistencia de contexto.
Scope: Requests a /api/ai/assistant incluyen accountId desde la cuenta activa. AI replies tambiÃ©n pasan accountId.
Archivos: src/components/ai/AIAssistant.tsx, src/components/compose/AITabs.tsx, src/components/feed/AIReplyDialog.tsx
Criterio: Con cuentas distintas, la IA refleja contextos distintos.

PR3 â€” Hardening multi-tenant en /api/ai/assistant
Objetivo: impedir fuga cross-account por accountId.
Scope: Verificar permisos antes de cargar AccountContext. Responder 403 si el usuario no pertenece a la cuenta.
Archivos: src/app/api/ai/assistant/route.ts
Criterio: Intento de accountId ajeno devuelve 403.

PR4 â€” Traducciones: literal vs "con voz" (claridad y no-regresiÃ³n)
Objetivo: que no se mezcle la traducciÃ³n literal gratis con la IA.
Scope: Confirmar que /api/ai/translate permanece literal y sin accountId. Ajustar labels/copy del AIAssistant.
Archivos: src/app/api/ai/translate/route.ts, src/components/feed/CastCard.tsx, src/components/ai/AIAssistant.tsx
Criterio: Translate del cast funciona igual que antes. Translate del asistente aplica BrandVoice.

PR5 â€” Generar BrandVoice desde casts (80â€“150) y prefill editable
Objetivo: activar Brand Mode sin que el usuario escriba desde cero.
Scope: Endpoint/acciÃ³n que genere brandVoice con casts (Neynar + IA). Guardado en account_knowledge_base.brand_voice. UI para "Generar BrandVoice".
Archivos: src/app/(app)/accounts/[id]/context/ContextEditor.tsx, nuevo endpoint API para generaciÃ³n
Criterio: Un click genera un borrador de BrandVoice y el usuario puede editar y guardar.

PR5.1 â€” HistÃ³rico de BrandVoice
Objetivo: mantener versiones anteriores para restauraciÃ³n.
Scope: AÃ±adir brand_voice_history a account_knowledge_base, migrar datos existentes.
Archivos: Schema/migraciÃ³n de DB, src/app/(app)/accounts/[id]/context/ContextEditor.tsx
Criterio: Cada guardado crea entrada en histÃ³rico; UI muestra versiones anteriores.

PR5.2 â€” Flujo de regeneraciÃ³n con diff/merge
Objetivo: permitir actualizaciÃ³n de BrandVoice con comparaciÃ³n.
Scope: UI de comparaciÃ³n, lÃ³gica de merge, confirmaciÃ³n.
Archivos: src/app/(app)/accounts/[id]/context/ContextEditor.tsx, src/components/context/BrandVoiceDiff.tsx (nuevo)
Criterio: Regenerar muestra diff; usuario puede elegir nuevo/merge/conservar.

PR5.3 â€” Manejo de errores y estados de generaciÃ³n
Objetivo: UX clara para todos los casos de error.
Scope: DetecciÃ³n de umbrales, validaciÃ³n post-gen, UI de errores.
Archivos: src/app/(app)/accounts/[id]/context/ContextEditor.tsx, src/lib/ai/brand-voice-generator.ts
Criterio: Cada estado tiene UI especÃ­fica; nunca se guarda sin confirmaciÃ³n.

PR6 â€” neverDo auto-sugerido (confirmable)
Objetivo: elevar brand safety sin fricciÃ³n.
Scope: GeneraciÃ³n de sugerencias + checklist "Aplicar seleccionadas".
Archivos: src/app/(app)/accounts/[id]/context/ContextEditor.tsx, endpoint/acciÃ³n de sugerencias
Criterio: No se aplican reglas sin confirmaciÃ³n explÃ­cita.

PR7 â€” (Opcional) Documentos (account_documents) para mayor fidelidad
Objetivo: llevar Brand Mode a nivel "marca real" (guidelines/claims/FAQs).
Scope: Empezar con resumen (sin RAG), o diseÃ±ar retrieval.
Criterio: La IA refleja guidelines documentales de forma medible.
Seguridad / multi-tenant
	â€¢	Cualquier endpoint que acepte accountId debe verificar que el usuario autenticado tiene permisos sobre esa cuenta.
	â€¢	internalNotes debe tratarse como informaciÃ³n interna (evitar filtrado accidental).
MÃ©tricas de producto (para validar el impacto)
	â€¢	% usuarios que activan Brand Mode (brandVoice completado)
	â€¢	Tiempo hasta activaciÃ³n
	â€¢	% usuarios que aceptan sugerencias de neverDo
	â€¢	SatisfacciÃ³n: regeneraciones vs aceptaciÃ³n de outputs
	â€¢	Tasa de ediciÃ³n manual tras generaciÃ³n (proxy de calidad)
Roadmap sugerido
	â€¢	Fase 1: gating (solo brandVoice) + banners/CTAs + bloqueo "All accounts"
	â€¢	Fase 2: generaciÃ³n de brandVoice desde 80â€“150 casts (Neynar + IA) y prefill editable
	â€¢	Fase 3: histÃ³rico y regeneraciÃ³n con diff/merge
	â€¢	Fase 4: auto-sugerencia de neverDo con confirmaciÃ³n
	â€¢	Fase 5: uso de account_documents (resumen o retrieval) para elevar fidelidad de marca
Preguntas abiertas
	â€¢	Â¿CÃ³mo versionar/regenerar BrandVoice cuando la marca cambia (rebrand)? â†’ Resuelto con flujo de diff/merge
	â€¢	Â¿QuÃ© ocurre si el usuario tiene "All accounts" seleccionadas? â†’ Resuelto: bloqueo con selector inline
	â€¢	Â¿CuÃ¡ntas versiones de histÃ³rico conservar antes de purgar?
	â€¢	Â¿Implementar notificaciones cuando el BrandVoice lleva mucho tiempo sin actualizar?
