AI Brand Mode
Brand Context Global ‚Äî Visi√≥n y Dise√±o (v2)

TL;DR (MVP v1)
1) IA generativa siempre trabaja con `accountId` (nunca inferido).
2) Si el usuario est√° en ‚ÄúAll accounts‚Äù (sin cuenta seleccionada): bloquear IA y pedir selecci√≥n inline.
3) Brand Mode se considera:
   - ON si `brandVoice` existe y no est√° vac√≠o.
   - OFF si no.
   OFF no significa ‚ÄúIA desactivada‚Äù: significa ‚Äúoutputs m√°s gen√©ricos‚Äù + CTA a completar contexto.
4) Traducci√≥n:
   - Translate literal del cast: no IA, no brand voice.
   - Translate con voz (assistant): IA generativa + brand-aware.

Comportamiento cuando Brand Mode est√° OFF (v1)
- La IA generativa sigue disponible (si hay cuenta seleccionada), pero:
  - no aplica `brandVoice`.
  - puede sonar ‚Äúgen√©rica‚Äù.
- UX: mostrar banner/notice con CTA a `/accounts/[id]/context`.

Limitaciones y garant√≠as (sin promesas m√°gicas)
- Sin RAG (retrieval), ‚ÄúNo inventar facts‚Äù es un objetivo, no una garant√≠a.
- Mitigaci√≥n pr√°ctica v1:
  - Instruir al modelo a ser conservador en claims y cifras.
  - Si falta informaci√≥n, preferir redacci√≥n neutral o pedir contexto (en vez de inventar).
- `account_documents` mejora fidelidad, pero si solo hay `documents_summary`:
  - cubre ‚Äúqu√© se puede decir‚Äù parcialmente y no sustituye fuentes completas.

Presupuesto de latencia/coste (para que esto sea deployable)
- Compose / AI Reply:
  - objetivo UX: respuesta percibida r√°pida (p.ej. <3s en la mayor√≠a de casos).
  - evitar prompts gigantes; preferir `brandVoice` breve + reglas.
- Analytics:
  - puede tolerar m√°s latencia; priorizar cach√© y resultados persistidos.
- Cache recomendado:
  - cachear `AccountContext` por `accountId` (KB) para no consultar DB en cada request.
  - `documents_summary` debe precomputarse y persistirse (no generarse en cada request).
  - `brand_voice_history` en JSONB array es v√°lido para v1 (m√°x 10), pero no es ‚Äúfinal‚Äù: si crece, migrar a tabla dedicada.

Objetivo
Habilitar que todas las features de IA generativa de Castor produzcan outputs consistentes con la voz de marca de una cuenta (brand voice) y sus reglas, sin exponer prompts editables a usuarios finales.
Principios
	‚Ä¢	El contexto de marca se gestiona a nivel de cuenta (account-level), orientado a equipos/marcas.
	‚Ä¢	No se permite edici√≥n directa de prompts: el control se hace mediante datos estructurados.
	‚Ä¢	El sistema debe ser consistente: cualquier surface de IA generativa debe operar con un accountId y su contexto.
	‚Ä¢	Separaci√≥n clara entre traducci√≥n literal (gratis, no IA) y traducci√≥n con voz (IA generativa, brand-aware).
Definiciones
Brand Context (Knowledge Base): datos estructurados persistidos en account_knowledge_base.
BrandVoice: texto breve que describe c√≥mo escribe la marca (tono, estilo, vocabulario, formato).
AI Brand Mode: estado ON/OFF que indica si se debe aplicar contexto de marca a la IA generativa.
IA generativa: modelos que producen texto nuevo (write, improve, reply, insights/chat, translate con voz).
Alcance
Incluye (IA generativa, brand-aware)
Asistente IA: write, improve, translate (con voz/localizaci√≥n)
AI Replies: sugerencias de respuesta
Analytics: insights/chat y recomendaciones generadas
Excluye
Translate literal del cast: feature gratis que ya funciona. No aplica brand voice. Debe permanecer literal sin reescritura estil√≠stica.
Fuente de verdad de contexto
Persistencia (DB)
account_knowledge_base: brandVoice, bio, expertise (array), alwaysDo (array), neverDo (array), hashtags (array), defaultTone, defaultLanguage, internalNotes, brand_voice_history (JSONB array)
account_documents: documentos adjuntos (brand guidelines, claims, FAQs, etc.)
UI
P√°gina de edici√≥n: /accounts/[id]/context (ContextEditor)
Activaci√≥n de AI Brand Mode (gating)
Regla de activaci√≥n (v1)
	‚Ä¢	AI Brand Mode = ON si brandVoice existe y no est√° vac√≠o.
	‚Ä¢	AI Brand Mode = OFF en caso contrario.
neverDo NO es obligatorio para activar (se considera recomendado).
Manejo del caso "All accounts"
Regla
Cuando el usuario tiene seleccionada la vista "All accounts", las features de IA generativa quedan bloqueadas con un mensaje que solicita seleccionar una cuenta espec√≠fica.
Justificaci√≥n
	‚Ä¢	Evita confusi√≥n sobre qu√© contexto de marca se est√° aplicando.
	‚Ä¢	Previene errores de publicaci√≥n con voz incorrecta.
	‚Ä¢	Simplifica la l√≥gica de accountId (siempre requerido, nunca inferido).
UI propuesta
En cualquier surface de IA generativa (AITabs, AI Reply, Analytics), si no hay cuenta seleccionada:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ‚ÑπÔ∏è  Selecciona una cuenta                   ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  Para usar el asistente de IA necesitas    ‚îÇ
‚îÇ  elegir una cuenta espec√≠fica.             ‚îÇ
‚îÇ                                             ‚îÇ
‚îÇ  [Selector de cuenta inline]               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Implementaci√≥n
	‚Ä¢	Verificar selectedAccountId antes de renderizar controles de IA.
	‚Ä¢	Si es null o "all", mostrar el bloqueo.
	‚Ä¢	El selector inline permite cambiar sin salir del contexto actual.
Onboarding propuesto
Objetivo
Reducir fricci√≥n: que el usuario pueda activar Brand Mode en minutos.
CTA
En cada surface de IA generativa (Studio/AITabs, AI Reply, Analytics), si Brand Mode est√° OFF:
	‚Ä¢	Mostrar banner/notice: "Activa AI Brand Mode completando tu Brand Voice."
	‚Ä¢	CTA: "Completar contexto" ‚Üí /accounts/[id]/context (cuenta activa)
Estados UX
	‚Ä¢	OFF: no hay brandVoice.
	‚Ä¢	ON: brandVoice presente.
	‚Ä¢	(Opcional) INCOMPLETE: KB existe pero brandVoice vac√≠o; mismo CTA.
"Translate con voz" (AIAssistant translate)
Intenci√≥n
No es traducci√≥n literal; es localizaci√≥n brand-aware:
	‚Ä¢	Mantener significado.
	‚Ä¢	Ajustar tono/registro a brandVoice.
	‚Ä¢	Respetar reglas (alwaysDo/neverDo) si existen.
Reglas
	‚Ä¢	Output: solo la versi√≥n final (sin explicaciones).
	‚Ä¢	No inventar facts.
	‚Ä¢	Si el texto contiene claims sensibles: mantenerse conservador.
Regeneraci√≥n y versionado de BrandVoice
Principio
El BrandVoice nunca se sobreescribe silenciosamente. Cualquier regeneraci√≥n es una propuesta de actualizaci√≥n que el usuario compara con la versi√≥n actual y decide c√≥mo resolver.
Triggers de regeneraci√≥n
	‚Ä¢	Evoluci√≥n natural del estilo (paso del tiempo)
	‚Ä¢	Rebrand consciente
	‚Ä¢	BrandVoice inicial de baja calidad
	‚Ä¢	Migraci√≥n de cuenta con nuevo historial
Flujo de regeneraci√≥n
	‚Ä¢	Usuario solicita "Actualizar BrandVoice"
	‚Ä¢	Selecciona ventana temporal (3 o 6 meses)
	‚Ä¢	Sistema genera nueva propuesta
	‚Ä¢	UI muestra comparaci√≥n lado a lado (actual vs nuevo)
	‚Ä¢	Usuario elige: Usar nuevo, Combinar ambos, o Conservar actual

UI de comparaci√≥n
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üìä Comparaci√≥n de BrandVoice                                   ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ACTUAL                          NUEVO (propuesto)              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ Tono directo y t√©cnico, ‚îÇ     ‚îÇ Tono directo pero m√°s   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ sin rodeos. Usa         ‚îÇ     ‚îÇ conversacional. Usa     ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ analog√≠as de producto.  ‚îÇ     ‚îÇ analog√≠as de producto   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ Prefiere frases cortas. ‚îÇ     ‚îÇ y referencias a la      ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ Evita emojis salvo üî•    ‚îÇ     ‚îÇ comunidad. M√°s emojis.  ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Cambios detectados:                                            ‚îÇ
‚îÇ  ‚Ä¢ + "m√°s conversacional"                                       ‚îÇ
‚îÇ  ‚Ä¢ + "referencias a la comunidad"                               ‚îÇ
‚îÇ  ‚Ä¢ ~ emojis: de "ocasionalmente" a "m√°s frecuente"              ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  [Usar nuevo]  [Combinar ambos]  [Conservar actual]             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Generaci√≥n de merge
Prompt interno para combinar versiones:
Combina estos dos BrandVoice en uno coherente.
Prioriza elementos espec√≠ficos sobre gen√©ricos.
Conserva restricciones expl√≠citas ("nunca", "siempre", "evita").
M√°ximo 200 palabras.

ACTUAL: {current_brand_voice}
NUEVO: {new_brand_voice}

Hist√≥rico de versiones
Modelo de datos
interface BrandVoiceHistoryEntry {
  id: string;
  content: string;
  createdAt: Date;
  source: 'manual' | 'generated' | 'merged';
  castsAnalyzed?: number;
  castsPeriod?: string;
  previousId?: string;
}

Almacenamiento: campo brand_voice_history (JSONB array) en account_knowledge_base.
Reglas
	‚Ä¢	M√°ximo 10 versiones conservadas.
	‚Ä¢	Versiones m√°s antiguas se eliminan (soft delete opcional para auditor√≠a).
	‚Ä¢	Cada guardado (nuevo, actualizaci√≥n, restauraci√≥n) crea una entrada.
UI de hist√≥rico
Accesible desde /accounts/[id]/context:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  üìú Historial de BrandVoice                                     ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Actual (guardado hace 2 d√≠as)                    [Activo]      ‚îÇ
‚îÇ  ‚îî‚îÄ Merged ‚Ä¢ 127 casts ‚Ä¢ Ene-Jun 2024                           ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Versi√≥n anterior (hace 4 meses)                  [Restaurar]   ‚îÇ
‚îÇ  ‚îî‚îÄ Generated ‚Ä¢ 89 casts ‚Ä¢ Sep-Dic 2023                         ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  Primera versi√≥n (hace 8 meses)                   [Restaurar]   ‚îÇ
‚îÇ  ‚îî‚îÄ Manual                                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Integraci√≥n de account_documents en el system prompt
Jerarqu√≠a de contexto
	‚Ä¢	brandVoice ‚Üí c√≥mo escribe la marca (tono, estilo)
	‚Ä¢	alwaysDo/neverDo ‚Üí reglas operativas
	‚Ä¢	documents_summary ‚Üí qu√© puede decir (claims, facts, messaging)
L√≥gica de integraci√≥n
brandVoice y documents_summary operan en dimensiones distintas: brandVoice = el c√≥mo, documents_summary = el qu√©. No compiten; se concatenan con roles claros en el system prompt:
Tu voz de marca:
{brandVoice}

Informaci√≥n oficial de la marca (no inventar fuera de esto):
{documents_summary}

Reglas:
- Siempre: {alwaysDo}
- Nunca: {neverDo}

L√≠mites (sin RAG)
	‚Ä¢	documents_summary limitado a ~500-800 tokens.
	‚Ä¢	Selecci√≥n manual de qu√© documentos incluir en el resumen.
	‚Ä¢	Cuando se requiera mayor fidelidad, implementar RAG (fuera de scope v1).
Generaci√≥n autom√°tica (asistida) del contexto
BrandVoice a partir de casts (Neynar + an√°lisis IA)
BrandVoice puede generarse autom√°ticamente a partir del historial de la cuenta.
¬øCu√°ntos casts analizar?
Recomendaci√≥n pr√°ctica:
	‚Ä¢	80‚Äì150 casts: mejor balance calidad/coste (recomendado).
	‚Ä¢	30‚Äì60 casts: onboarding r√°pido (m√°s sesgo).
	‚Ä¢	200‚Äì400 casts: cuentas con m√∫ltiples tem√°ticas o estilo editorial.
	‚Ä¢	800‚Äì1000 casts: rendimientos decrecientes para BrandVoice puro.
Muestreo recomendado
	‚Ä¢	Ventana temporal: 3‚Äì6 meses (marca actual).
	‚Ä¢	Priorizar casts originales (texto propio).
	‚Ä¢	Excluir posts vac√≠os/solo links.
	‚Ä¢	Dedupe de plantillas repetidas.
	‚Ä¢	Incluir una fracci√≥n de replies si quieres reflejar estilo conversacional.
neverDo auto-sugerido (confirmable)
neverDo puede sugerirse autom√°ticamente y requerir confirmaci√≥n expl√≠cita del usuario.
UX sugerido en /accounts/[id]/context:
	‚Ä¢	Bloque: "Sugerir reglas (never do) autom√°ticamente"
	‚Ä¢	Acci√≥n: "Generar sugerencias"
	‚Ä¢	UI: checklist + "Aplicar seleccionadas"
Manejo de errores en generaci√≥n de BrandVoice
Estados y umbrales
Estado
Condici√≥n
Comportamiento
insufficient_data
< 30 casts (filtrados)
Bloquear generaci√≥n, ofrecer escritura manual
low_confidence
30-79 casts, o alta varianza
Warning visible, resultado editable
success
80+ casts, se√±al clara
Resultado editable, flujo normal
generation_failed
Error de API (Neynar o IA)
Retry autom√°tico (1x), fallback manual
too_generic
Validaci√≥n detecta frases vac√≠as
Sugerir edici√≥n o regenerar

Detecci√≥n de alta varianza
Heur√≠sticas que disparan low_confidence:
	‚Ä¢	> 50% de casts son solo links/media sin texto
	‚Ä¢	Mezcla de 3+ idiomas sin patr√≥n dominante
	‚Ä¢	Desviaci√≥n est√°ndar de longitud de casts > 80% de la media
Validaci√≥n post-generaci√≥n
Antes de mostrar el resultado:
	‚Ä¢	¬øMenos de 50 caracteres? ‚Üí Regenerar autom√°ticamente (1x)
	‚Ä¢	¬øContiene frases gen√©ricas? (lista negra: "profesional y cercano", "amigable pero formal") ‚Üí Marcar como too_generic
	‚Ä¢	¬øM√°s de 1500 caracteres? ‚Üí Truncar con aviso
UI por estado
insufficient_data
‚ö†Ô∏è Necesitas m√°s historial

Encontramos solo {n} casts en los √∫ltimos 6 meses.
Para generar un BrandVoice fiable necesitamos al menos 30.

[Escribir manualmente]  [Cancelar]

low_confidence
ü§î Resultado preliminar

Tu historial es muy variado, as√≠ que este BrandVoice
es un punto de partida. Te recomendamos editarlo.

[Ver resultado y editar]

generation_failed
‚ùå No pudimos generar tu BrandVoice

Hubo un problema al analizar tus casts.

[Reintentar]  [Escribir manualmente]

too_generic
üòê El resultado es demasiado gen√©rico

No encontramos suficiente se√±al distintiva en tus casts.
Te recomendamos escribirlo manualmente o editar esto como base.

[Editar resultado]  [Escribir desde cero]

Consistencia t√©cnica (dise√±o)
Regla de oro
Toda llamada de IA generativa debe ejecutarse con un accountId (cuenta activa) cargando AccountContext desde esa cuenta.
Consideraciones
	‚Ä¢	Centralizar la construcci√≥n de contexto (system context) en una funci√≥n √∫nica (p.ej. buildSystemContext(...)).
	‚Ä¢	Reutilizar el mismo contrato de datos entre assistant/replies/analytics.
Implementaci√≥n (checklist)
Esta secci√≥n describe qu√© tocar en el c√≥digo para llevar esta visi√≥n a producci√≥n. No es un refactor masivo: es un set de cambios peque√±os pero consistentes.
Plan por PRs (ejecuci√≥n recomendada)
PR1 ‚Äî Brand Mode gating + CTA (solo UI)
Objetivo: que el usuario entienda y pueda activar Brand Mode.
Scope: Banner/notice cuando Brand Mode est√° OFF. CTA a /accounts/[id]/context con la cuenta activa.
Archivos: src/components/compose/AITabs.tsx, src/components/feed/AIReplyDialog.tsx
Criterio: Si brandVoice est√° vac√≠o, se ve el CTA. Si brandVoice existe, el CTA no aparece.

PR1.1 ‚Äî Bloqueo de IA en "All accounts"
Objetivo: impedir uso de IA generativa sin cuenta seleccionada.
Scope: Verificar selectedAccountId antes de renderizar IA generativa.
Archivos: src/components/compose/AITabs.tsx, src/components/feed/AIReplyDialog.tsx, src/context/SelectedAccountContext.tsx
Criterio: Si no hay cuenta seleccionada, mostrar bloqueo con selector inline.

PR2 ‚Äî Propagar accountId a IA generativa (assistant + replies)
Objetivo: asegurar consistencia de contexto.
Scope: Requests a /api/ai/assistant incluyen accountId desde la cuenta activa. AI replies tambi√©n pasan accountId.
Archivos: src/components/ai/AIAssistant.tsx, src/components/compose/AITabs.tsx, src/components/feed/AIReplyDialog.tsx
Criterio: Con cuentas distintas, la IA refleja contextos distintos.

PR3 ‚Äî Hardening multi-tenant en /api/ai/assistant
Objetivo: impedir fuga cross-account por accountId.
Scope: Verificar permisos antes de cargar AccountContext. Responder 403 si el usuario no pertenece a la cuenta.
Archivos: src/app/api/ai/assistant/route.ts
Criterio: Intento de accountId ajeno devuelve 403.

PR4 ‚Äî Traducciones: literal vs "con voz" (claridad y no-regresi√≥n)
Objetivo: que no se mezcle la traducci√≥n literal gratis con la IA.
Scope: Confirmar que /api/ai/translate permanece literal y sin accountId. Ajustar labels/copy del AIAssistant.
Archivos: src/app/api/ai/translate/route.ts, src/components/feed/CastCard.tsx, src/components/ai/AIAssistant.tsx
Criterio: Translate del cast funciona igual que antes. Translate del asistente aplica BrandVoice.

PR5 ‚Äî Generar BrandVoice desde casts (80‚Äì150) y prefill editable
Objetivo: activar Brand Mode sin que el usuario escriba desde cero.
Scope: Endpoint/acci√≥n que genere brandVoice con casts (Neynar + IA). Guardado en account_knowledge_base.brand_voice. UI para "Generar BrandVoice".
Archivos: src/app/(app)/accounts/[id]/context/ContextEditor.tsx, nuevo endpoint API para generaci√≥n
Criterio: Un click genera un borrador de BrandVoice y el usuario puede editar y guardar.

PR5.1 ‚Äî Hist√≥rico de BrandVoice
Objetivo: mantener versiones anteriores para restauraci√≥n.
Scope: A√±adir brand_voice_history a account_knowledge_base, migrar datos existentes.
Archivos: Schema/migraci√≥n de DB, src/app/(app)/accounts/[id]/context/ContextEditor.tsx
Criterio: Cada guardado crea entrada en hist√≥rico; UI muestra versiones anteriores.

PR5.2 ‚Äî Flujo de regeneraci√≥n con diff/merge
Objetivo: permitir actualizaci√≥n de BrandVoice con comparaci√≥n.
Scope: UI de comparaci√≥n, l√≥gica de merge, confirmaci√≥n.
Archivos: src/app/(app)/accounts/[id]/context/ContextEditor.tsx, src/components/context/BrandVoiceDiff.tsx (nuevo)
Criterio: Regenerar muestra diff; usuario puede elegir nuevo/merge/conservar.

PR5.3 ‚Äî Manejo de errores y estados de generaci√≥n
Objetivo: UX clara para todos los casos de error.
Scope: Detecci√≥n de umbrales, validaci√≥n post-gen, UI de errores.
Archivos: src/app/(app)/accounts/[id]/context/ContextEditor.tsx, src/lib/ai/brand-voice-generator.ts
Criterio: Cada estado tiene UI espec√≠fica; nunca se guarda sin confirmaci√≥n.

PR6 ‚Äî neverDo auto-sugerido (confirmable)
Objetivo: elevar brand safety sin fricci√≥n.
Scope: Generaci√≥n de sugerencias + checklist "Aplicar seleccionadas".
Archivos: src/app/(app)/accounts/[id]/context/ContextEditor.tsx, endpoint/acci√≥n de sugerencias
Criterio: No se aplican reglas sin confirmaci√≥n expl√≠cita.

PR7 ‚Äî (Opcional) Documentos (account_documents) para mayor fidelidad
Objetivo: llevar Brand Mode a nivel "marca real" (guidelines/claims/FAQs).
Scope: Empezar con resumen (sin RAG), o dise√±ar retrieval.
Criterio: La IA refleja guidelines documentales de forma medible.
Seguridad / multi-tenant
	‚Ä¢	Cualquier endpoint que acepte accountId debe verificar que el usuario autenticado tiene permisos sobre esa cuenta.
	‚Ä¢	internalNotes debe tratarse como informaci√≥n interna (evitar filtrado accidental).
M√©tricas de producto (para validar el impacto)
	‚Ä¢	% usuarios que activan Brand Mode (brandVoice completado)
	‚Ä¢	Tiempo hasta activaci√≥n
	‚Ä¢	% usuarios que aceptan sugerencias de neverDo
	‚Ä¢	Satisfacci√≥n: regeneraciones vs aceptaci√≥n de outputs
	‚Ä¢	Tasa de edici√≥n manual tras generaci√≥n (proxy de calidad)
Roadmap sugerido
	‚Ä¢	Fase 1: gating (solo brandVoice) + banners/CTAs + bloqueo "All accounts"
	‚Ä¢	Fase 2: generaci√≥n de brandVoice desde 80‚Äì150 casts (Neynar + IA) y prefill editable
	‚Ä¢	Fase 3: hist√≥rico y regeneraci√≥n con diff/merge
	‚Ä¢	Fase 4: auto-sugerencia de neverDo con confirmaci√≥n
	‚Ä¢	Fase 5: uso de account_documents (resumen o retrieval) para elevar fidelidad de marca
Preguntas abiertas
	‚Ä¢	¬øC√≥mo versionar/regenerar BrandVoice cuando la marca cambia (rebrand)? ‚Üí Resuelto con flujo de diff/merge
	‚Ä¢	¬øQu√© ocurre si el usuario tiene "All accounts" seleccionadas? ‚Üí Resuelto: bloqueo con selector inline
	‚Ä¢	¬øCu√°ntas versiones de hist√≥rico conservar antes de purgar?
	‚Ä¢	¬øImplementar notificaciones cuando el BrandVoice lleva mucho tiempo sin actualizar?
